@{
    ViewBag.Title = "Index";
}

<h2>Home</h2>
@if (User.Identity.IsAuthenticated)
{
    <h2>Logged in as @User.Identity.Name</h2>
    <div>
        <a href="~/Home/Logout">Logout</a>
        <button id="api">Call API</button>
    </div>
    <pre id="result"></pre>
    <dl>
        @foreach (var claim in ((System.Security.Claims.ClaimsPrincipal)User).Claims)
        {
            <dt>@claim.Type</dt>
            <dd>@claim.Value</dd>
        }
    </dl>
}
else
{
    <h2>Not logged in</h2>
    <div>
        <a href="~/Home/Login">Login</a>
    </div>
}


<script>
    @{
        var cp = (System.Security.Claims.ClaimsPrincipal)User;
        var at_claim = cp.Claims.FirstOrDefault(x => x.Type == "access_token");
        var token = "";
        if (at_claim != null)
        {
            token = at_claim.Value;
        }
    }
    var access_token = '@token';

    document.getElementById('api').addEventListener("click", function () {

        var xhr = new XMLHttpRequest();
        xhr.onload = function () {
            console.log(xhr.responseText);
            document.getElementById('result').innerText = JSON.stringify(JSON.parse(xhr.responseText), null, 2);
        };
        xhr.open("GET", "/api/test");
        xhr.setRequestHeader("Authorization", "Bearer " + access_token);
        xhr.send();
    }, false);
</script>